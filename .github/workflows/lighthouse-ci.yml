# ─── Lighthouse CI Workflow ──────────────────────────────────────────────────
#
# Runs Lighthouse audits on key pages after every PR that changes web/ files.
# Fails the check if any score drops below the threshold.
#
# AUDITED PAGES:
# - / (landing page)
# - /algorithms (catalog)
# - /algo/binary-search (representative algorithm page)
#
# THRESHOLDS (from Architecture §10):
# - Performance:    >= 95
# - Accessibility:  >= 95
# - Best Practices: >= 95
# - SEO:            >= 95

name: Lighthouse CI

on:
  pull_request:
    paths:
      - "web/**"
      - "algorithms/**"

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        run: cd web && npm ci

      - name: Build
        run: cd web && npm run build

      - name: Start Next.js server
        run: |
          cd web
          npm run start -- -p 3000 &
          # Wait for the server to be ready (up to 30 seconds)
          for i in $(seq 1 30); do
            if curl -sf http://localhost:3000 > /dev/null 2>&1; then
              echo "Server is ready."
              break
            fi
            if [ "$i" -eq 30 ]; then
              echo "Server failed to start within 30 seconds."
              exit 1
            fi
            sleep 1
          done

      - name: Run Lighthouse
        uses: treosh/lighthouse-ci-action@v11
        with:
          urls: |
            http://localhost:3000/
            http://localhost:3000/algorithms
            http://localhost:3000/algo/binary-search
          budgetPath: web/lighthouse-budget.json
          uploadArtifacts: true

      - name: Assert scores
        run: |
          echo "Checking Lighthouse scores against thresholds..."
          THRESHOLD=0.95
          FAILED=0

          for file in .lighthouseci/lhr-*.json; do
            if [ ! -f "$file" ]; then
              echo "No Lighthouse results found."
              exit 1
            fi

            URL=$(jq -r '.requestedUrl' "$file")
            PERF=$(jq '.categories.performance.score' "$file")
            A11Y=$(jq '.categories.accessibility.score' "$file")
            BP=$(jq '.categories["best-practices"].score' "$file")
            SEO=$(jq '.categories.seo.score' "$file")

            echo ""
            echo "Results for $URL:"
            echo "  Performance:    $PERF"
            echo "  Accessibility:  $A11Y"
            echo "  Best Practices: $BP"
            echo "  SEO:            $SEO"

            for LABEL_SCORE in "Performance:$PERF" "Accessibility:$A11Y" "Best Practices:$BP" "SEO:$SEO"; do
              LABEL="${LABEL_SCORE%%:*}"
              SCORE="${LABEL_SCORE#*:}"
              if [ "$(echo "$SCORE < $THRESHOLD" | bc -l)" -eq 1 ]; then
                echo "  FAIL: $LABEL ($SCORE) is below $THRESHOLD for $URL"
                FAILED=1
              fi
            done
          done

          echo ""
          if [ "$FAILED" -eq 1 ]; then
            echo "Lighthouse score assertion FAILED. One or more scores are below the $THRESHOLD threshold."
            exit 1
          fi
          echo "All Lighthouse scores meet the $THRESHOLD threshold."
